<?php
// $Id$

/**
 * @file
 * Imports users from a coma seperated file (csv).
 */

/**
 * Implementation of hook_help().
 */
function user_import_help($section) {
  switch ($section) {
    case 'admin/modules#description':
      return t('Imports users from a coma seperated file (csv).');
    case 'admin/settings/user_import':
      return t("Imports users from a coma seperated file (csv). Click 'Add Import' to start a new import.");
  }
}


/**
 * Implementation of hook_perm().
 */
function user_import_perm() {
  return array('import users');
}


/**
 * Implementation of hook_menu().
 */
function user_import_menu($may_cache) {
  
  global $user;
  $items = array();
  
     if ($may_cache) {     
     
        $items[] = array(
            'path' => 'admin/settings/user_import', 
            'title' => t('user imports'), 
            'callback' => 'user_import_callback_overview',
            'access' => user_access('import users'),
            );
        $items[] = array(
            'path' => 'admin/settings/user_import/list', 
            'title' => t('list imports'), 
            'type' => MENU_DEFAULT_LOCAL_TASK, 
            'access' => user_access('import users'),
            'weight' => -10
            );
        $items[] = array(
          'path' => 'admin/settings/user_import/add', 
          'title' => t('add import'),
          'callback' => 'user_import_callback_add',
          'access' => user_access('import users'),
          'type' => MENU_LOCAL_TASK
        );
        $items[] = array(
          'path' => 'admin/settings/user_import/configure', 
          'title' => t('configure'),
          'callback' => 'user_import_callback_configure',
          'access' => user_access('import users'),
          'type' => MENU_LOCAL_TASK
        );
        $items[] = array(
          'path' => 'admin/settings/user_import/errors', 
          'callback' => 'user_import_callback_errors',
          'access' => user_access('import users'),
          'type' => MENU_CALLBACK
        );     }

  return $items;
}

function user_import_callback_overview() {

    $edit = $_POST["edit"];
    $operation = $_POST["op"];
    
    switch ($operation) {
        case t('Settings'):
            drupal_goto ('admin/settings/user_import/add/' . $edit['iid']);
            break;
            
        case t('Delete'):
            db_query("DELETE FROM {user_import} WHERE iid = '%d'", $edit['iid']);
            db_query("DELETE FROM {user_import_errors} WHERE iid = '%d'", $edit['iid']);
            $message = t("Imported file and info about the import have been deleted.");
            $file = file_check_upload($edit['file_handle']);
            if ($file) {
                file_delete($file->filepath);
                $message .= ' ' . t("File '$file->filename' has been deleted.");
                Unset($file);
            }
            
            drupal_set_message ($message);
            break;
            
        case t('Continue Processing'):
            $import = user_import_select_imports($edit['iid']);
            user_import_process($import);
            break;
    }

    $output = theme('user_import_overview');
    print theme('page', $output);
    return;
}


function user_import_callback_add($iid = NULL) {

    $edit = $_POST["edit"];
    $operation = $_POST["op"];

    $file_name = ($edit['file_handle']) ? $edit['file_handle'] : 'csv_' . time();  
    $file = file_check_upload($file_name);

    switch ($operation) {
        case t('Test'):
            _user_import_validate_add($edit);
    
            if (!form_get_errors()) {
                
                // in case these settings need to be saved
                _user_import_setting_save($edit);
               
                $edit['setting'] = 'test';
                user_import_process($edit);
                drupal_set_message (t('Tested'));
                drupal_goto ('admin/settings/user_import/list');
            }
            break;
            
        case t('Import'):    
            _user_import_validate_add($edit);
            
            // in case these settings need to be saved
            _user_import_setting_save($edit);
            
            if (!form_get_errors()) {
                $edit['setting'] = 'import';
                user_import_process($edit);
                drupal_set_message (t('Imported'));
                drupal_goto ('admin/settings/user_import/list');
            }
            break;  
            
        case t('Upload'):  
            $file = file_save_upload($file_name);
            
            // check if we're using saved settings
            if ($edit['load_settings']) {
                $load_settings = $edit['load_settings'];
                $edit = user_import_select_imports($edit['load_settings'], 'get saved');
                $edit['iid'] = NULL;
                $edit['load_settings'] = $load_settings;
                $edit['saved_settings_name'] = $edit['name'];
                $edit['name'] = NULL;
            }
            
            // TO DO
            // currently function screws up line endings
            // make it work to convert other file formats
            // user_import_file_cleaner($file->filepath);
            break;
            
        case t('Remove file'):
            if ($file) {
                file_delete($file->filepath);
                Unset($file);
            }
            break;
        default:
            
            // user is comming from list view
            if ($iid) {
                // load info for this import
                $edit = user_import_select_imports($iid);
                $file_name = ($edit['file_handle']) ? $edit['file_handle'] : 'csv_' . time();  
                $file = file_check_upload($file_name);
                $options .= form_hidden ('iid', $iid);
            } else {
                $edit['load_settings'] = variable_get('user_import_default_settings', 0);
            }
            break;
        }
    
    // Upload file form
    if (!$file) {
        $output = theme('user_import_upload', $edit, $file_name);
        return print theme('page', $output);
    }  
    
    // check file exists
    $handle = @fopen($file->filepath, "r");
    if (!$handle) {
        drupal_set_message (t("Could not find the csv file '%filename'", array('%filename' => $file->filename)), 'error');
        return print theme('page', t("Please add your file again."));
    }
    
    // get first row of file
    $data_row = @fgetcsv ($handle, 1000000, ",");
    if (!$data_row) {
        drupal_set_message (t("Could not get data, the file '%filename' is either empty or has incompatible line endings.", array('%filename' => $file->filename)), 'error');
        return print theme('page', t("Check the contents of the file '%filename'.", array('%filename' => $file->filename)));
    }

    $output = theme('user_import_settings', $edit, $file, $file_name, $data_row, $iid);
    
    print theme('page', $output);
    return;
}


function user_import_callback_errors($iid = NULL) {

    if (!$iid) drupal_goto('admin/settings/user_import');
    
    // get profile fields
    $profile_fields = user_import_profile_fields();
    
    // add email address options
    $profile_fields['email'] = t('Email Address') . '*';
    asort($profile_fields);
    
    $settings = user_import_select_imports($iid);

    foreach($settings['field_match'] as $field) {     
        if ($field != '0') $header[] = $profile_fields[$field];
    }
 
    $results = db_query("SELECT * FROM {user_import_errors} WHERE iid = '%d'", $iid);
    while ($row = db_fetch_array($results)) {
        $row['data'] = unserialize($row['data']);
        $file_lines[] = $row;
    }

    foreach ($file_lines as $file_line) {

        $row = NULL;
        foreach($file_line['data'] as $file_cell) {
            $row[] = array("data" => substr($file_cell, 0, 40), "align" => "left");
        }
        
        $row[] = $file_line['error'];
        $rows[] = $row;
    }
  
    $header[] = t('error');
    
    $output .= theme('table', $header, $rows);    
    print theme('page', $output);
    return;
}

function user_import_callback_configure() { 
    
    $edit = $_POST["edit"];
    $operation = $_POST["op"];
    
    switch ($operation) {
        case t('Save'):
            $edit = user_import_validate_configuration($edit);
            variable_set('user_import_max', $edit['user_import_max']);
            variable_set('user_import_line_max', $edit['user_import_line_max']);
            variable_set('user_import_default_settings', $edit['load_settings']);
            if (!form_get_errors()) drupal_set_message(t("Settings have been saved."));
            break;
        
        default:
            $edit['user_import_max'] = variable_get('user_import_max', 250);
            $edit['user_import_line_max'] = variable_get('user_import_line_max', 1000);
            $edit['load_settings'] = variable_get('user_import_default_settings', 0);
            break;
    }
    
    $output .= form_textfield(t('Maximum Users/Process'), 'user_import_max', $edit['user_import_max'], 10, 10, t('Maximum number of users to import each time the file is processed, useful for controling the rate at which emails are sent out.'));
    $output .= form_textfield(t('Maximum length of line'), 'user_import_line_max', $edit['user_import_line_max'], 10, 10, t('The default is set at 1,000 characters, if a line in your csv is longer than this you should set a higher maximum here. Setting higher maximums will slow down imports.'));
    
    $settings = user_import_select_imports(NULL, 'get saved');
    
    if ($settings) {
 
        $saved_settings = array('-- none --');
        foreach ($settings AS $settings_set) {
            $saved_settings[$settings_set['iid']] = $settings_set['name'];
        }
 
        $output  .= form_select(t('Default Settings'), 'load_settings', $edit['load_settings'], $saved_settings, t('Select if you want to use a previously saved set of settings as default for all imports.'));
    } 
    


    $output .= form_submit(t('Save'));
    $output = form($output);
    
    print theme('page', $output);
    return;
}


// Create Username    
function user_import_create_username($order, $data, $abbreviate) {

    if ($data) {
    
        asort($order);
        reset($order);
    
        while (list ($file_column, $sequence) = each ($order)) {
            
            $username .= ($abbreviate[$file_column] == 1) ? trim(strtoupper(chr(ord($data[$file_column])))) : trim($data[$file_column]);
        }

    } else {
        $username = user_import_random_username();
    }
    
    $exists_username = user_import_validate_username($username);
    
    // add number at end of username if it already exists
    if ($exists_username) {

        $count = user_import_count_usernames($username);
        $count++;
        $username = $username . $count;
    }
    
    return $username;
}
    
// Check for a duplicate in Username    
function user_import_validate_username($username) {

    $result = db_result(db_query("SELECT uid from {users} where name = '%s' LIMIT 1", $username));
    return $result ;
}

function user_import_count_usernames($username) {

    $result = db_result(db_query("SELECT COUNT(uid) from {users} where name LIKE '%s%s'", $username, '%'));
    return $result ;
}

// Check for a duplicate email address
function user_import_validate_email($email = NULL) {

    if (!$email) return 'no email';
    
    if (!valid_email_address($email)) return 'invalid email';
    
    $result = db_result(db_query("SELECT uid from {users} where mail= '%s' LIMIT 1", $email));
    if ($result) return 'duplicate email';
 
    return;
}


function user_import_insert_profile($field, $uid, $value) {
    
    $profile = db_query("INSERT INTO {profile_values} (fid,uid,value) VALUES('%d','%d','%s')", $field, $uid, $value);
    return;
}

function theme_user_import_overview() {
    
    $imports = user_import_select_imports();
    
    if ($imports) {
        foreach ($imports as $import) {
            $row = NULL;
            $file = file_check_upload($import['file_handle']);
            $import_label = ($import['setting'] == 'tested' || $import['setting'] == 'test') ? t('importable') : t('imported');
            $header = array(t('filename'), t('date'), t('processed'), $import_label, t('errors'), t('mode'));
            $errors = db_result(db_query("SELECT COUNT(iid) FROM {user_import_errors} WHERE iid = '%d'", $import['iid']));
            $errors_link = ($errors == 0) ? 0: l($errors, 'admin/settings/user_import/errors/' . $import['iid']);
            $row = array(array( 
                array("data" => $file->filename, "align" => 'left'),  
                array("data" => format_date($import['started'], 'small'), "align" => 'left'), 
                array("data" => $import['processed'], "align" => 'center'),
                array("data" => $import['valid'], "align" => 'center'),
                array("data" => $errors_link, "align" => 'center'),
                array("data" => $import['setting'], "align" => 'center'),
            ));
            
            $form = theme('table', $header, $row);
    
            $form .= form_hidden ('iid' , $import['iid']);
            if ($import['setting'] == 'test' || $import['setting']  == 'import') $form .= form_submit(t('Continue Processing'));
            $form .= form_submit(t('Settings'));
            $form .= form_submit(t('Delete'));
            
            $output .= form($form);
        }
    }
    
    return $output;
}

// Display file import form
function theme_user_import_settings($edit, $file, $file_name, $data_row, $iid = NULL) {
    
    // get profile fields
    $profile_fields = user_import_profile_fields();
    
    // add default and email address options
    $profile_fields[0] = '-------------';
    $profile_fields['email'] = t('Email Address') . '*';
    $profile_fields['password'] = t('Password');
    asort($profile_fields);  
    
    $column = 0;
    $sort = array(t('no'), 1, 2, 3, 4);
    
    foreach($data_row as $data_cell) {
            
            $info = substr($data_cell, 0, 40);
            
            $field_match_rows[] = array( 
                                array("data" => $info, "align" => "left"), 
                                array("data" => form_select(NULL, 'field_match][' . $column, $edit['field_match'][$column], $profile_fields), "align" => "left"),
                                array("data" => form_select(NULL, 'username][' . $column, $edit['username'][$column], $sort), "align" => "center"),
                                array("data" => form_checkbox(NULL, 'abbreviate][' . $column, 1, $edit['abbreviate'][$column]), "align" => "center")
                            );
            
            $column++;
    }
    
    // Process file form
    $remove .= form_item(t('Uploaded file'), sprintf("%s (%d Bytes)", $file->filename, $file->filesize));
    $remove .= form_submit(t('Remove file'));
    $remove = form_group(t('CSV file'), $remove, t('Remove file to use a different file.'));
    $output .= form($remove);
    
    if ($iid) $options .= form_hidden ('iid', $iid);
    $options .= form_hidden ('file_handle' , $file_name);
    $options .= form_checkbox(t('Ignore First Line'), 'first_line', 1, $edit['first_line'], t("If the first line is the names of the data columns, set to ignore first line."));
    $options .= form_checkbox(t('Contact'), 'contact', 1, $edit['contact'], t("Set each user's personal contact form to 'allowed'."));
    $options .= form_checkbox(t('Send Email'), 'send_email', 1, $edit['send_email'], t('Send email to users when their account is created.'));
    $options = form_group(t('Options'), $options);
    
    $field_match_header = array(t('csv column'), t('Drupal fields'), t('username'), t('abbreviate'));
    $fieldmatch .= theme('table', $field_match_header, $field_match_rows, array('id' => 'select-match'));
    $group_text = t("Match columns in CSV file to profile fields, leave as '----' if there is no match.");
    $group_text .= '<br /><strong>' . t('Username') . ': </strong>' . t("The Username will be built from CSV columns in the order selected.");
    $group_text .= '<br /><strong>' . t('Abbreviate') . ': </strong>' . t("Use the first letter of a field in uppercase for the Username, e.g. 'john' -> 'J'.");
    $group_text .= '<br />' . t("If no CSV fields are selected, the Username will be randomly generated.");
    $options .= form_group(t('Field Match'), $fieldmatch, $group_text);    
     

    $roles_data = user_roles();

    while (list ($rid, $role_name) = each ($roles_data)) {
        if ($rid != 1) $roles .= form_checkbox($role_name, 'roles][' . $rid, 1, $edit['roles'][$rid]);
    }

    $options .= form_group(t('Role Assign'), $roles, t('Select which role(s) imported users should be assigned.'));
    
    if ($edit['load_settings']) {
        $save_settings = form_hidden ('load_settings', $edit['load_settings']);
        $save_settings .= form_hidden ('saved_settings_name', $edit['saved_settings_name']);
        $save_settings .= form_checkbox(t('Update'), 'update', 1, $edit['update'], t("Update saved settings for '%name'", array('%name' => $edit['saved_settings_name'])));
        $save_settings .= form_textfield(t('Save As New'), 'name', $edit['name'], 30, 25, t('Input a name to save settings as a new set.'));
        $options .= form_group(t('Saved Settings'), $save_settings, t("If you've made changes to the settings since you saved them you can update the saved set, or save them as a new set."));
    } else {
        $save_settings = form_textfield(t('Settings Name'), 'name', $edit['name'], 30, 25, t('Name this set of settings if you want to save them.'));
        $options .= form_group(t('Save Settings'), $save_settings, t('Save settings for re-use on other imports.'));
    }

    $options .= form_submit(t('Test'));
    $options.= form_submit(t('Import'));
    
    $output .= form($options, 'post', NULL, array('id' => 'user-import'));
    return $output;
}

// Display file import form
function theme_user_import_upload($edit, $file_name) {
    
    $output .= form_hidden ('send_email' , 1);
    $output .= form_hidden ('contact' , 1);
    $output .= form_hidden ('roles][2', 1);
    $output .= form_hidden ('file_handle' , $file_name);
    $output .= form_hidden ('file_handle' , $file_name);
    $output .= form_file(t('Select CSV file'), $file_name, 50, t('Select the CSV file to be imported.'), TRUE);   
    $output  = form_group(t('CSV File'), $output);
    
    $settings = user_import_select_imports(NULL, 'get saved');
    
    if ($settings) {
 
        $saved_settings = array('-- none --');
        foreach ($settings AS $settings_set) {
            $saved_settings[$settings_set['iid']] = $settings_set['name'];
        }

        $settings = form_select(t('Saved Settings'), 'load_settings', $edit['load_settings'], $saved_settings);
        $output  .= form_group(t('Settings'), $settings, t('Select if you want to use a previously saved set of settings.'));
    } 
    
    $output  .= form_submit(t('Upload'));
    $output  = form($output, 'post', 0, array("enctype" => "multipart/form-data"));
    return $output;
}


// Display errors table
function theme_user_import_duplicates_table($rows) {

    $header = array(t('first name'), t('last name'), t('email'));
    $output = theme('table', $header, $rows, array('id' => 'enewsletter-admin'));
    return $output;
}

// A custom theme function.
function theme_user_import_duplicate($user_data) {

    foreach ($user_data as $data) {
        $row[] = array('data' => $data, 'align' => 'left');
    }

    return $row;
}

// Send email when account is created    
function user_import_send_email($account, $password) {

    global $base_url;
    $from = variable_get('site_mail', ini_get('sendmail_from'));

    $variables = array('%username' => $account->name, '%site' => variable_get('site_name', 'drupal'), '%password' => $password, '%uri' => $base_url, '%uri_brief' => substr($base_url, strlen('http://')), '%mailto' => $account->mail, '%date' => format_date(time()), '%login_uri' => url('user', NULL, NULL, TRUE), '%edit_uri' => url('user/'. $account->uid .'/edit', NULL, NULL, TRUE));

    $subject = _user_mail_text('welcome_subject', $variables);
    $body = _user_mail_text('welcome_body', $variables);
    user_mail($account->mail, $subject, $body, "From: $from\nReply-to: $from\nX-Mailer: Drupal\nReturn-path: $from\nErrors-to: $from");
    return;
}

function user_import_profile_fields() {
    
    if (!module_exist('profile')) return;
    
    $results = db_query("SELECT DISTINCT(fid), title FROM {profile_fields}");

    while ($row = db_fetch_object($results)) {
        $profile_fields[$row->fid] = $row->title;
    }
    
    return $profile_fields;
}


function user_import_list_profile_fields($return = 'string') {
    
    if (!module_exist('profile')) return;
    
    $results = db_query("SELECT DISTINCT(fid), title, name FROM {profile_fields}");

    while ($row = db_fetch_object($results)) {
        $profile_fields[$row->fid] = $row;
    }
    
    if (!$profile_fields) return;
    
    if ($return == 'array') return $profile_fields;
    
    $content = '<p>' . t('Profile tags available:') . '<br />';

    foreach ($profile_fields as $field) {
        $content .= '<strong>' . $field->title . ':</strong> $' . $field->name . '<br />';
    }
    
    $content .= '</p>';
    
    return $content;
}



function _user_import_validate_add(&$edit) {

   $field_match = $edit['field_match'];
   
   // in case of injection (normaly $field_match will always be an array)
   if (!is_array($field_match)) return form_set_error('field_match[1]',  t('At least one column of the csv file must be set as the email address.'));
   
   $counts = array_count_values($field_match);
   while (list ($value, $count) = each ($counts)) {
        // check each field is unique
        if ($value != 0 && $count > 1) $duplicate[$value] = $count;
        // check email address has been selected
        if ("$value" == 'email') $email = TRUE;
   }
   
   if ($duplicate) form_set_error('field_match[1]', t('Database fields can only be matched to one column of the csv file.'));
   
   if (!$email) {
        form_set_error('field_match[1]', t('One column of the csv file must be set as the email address.'));
   }
   
   // check at least one role has been chosen
   $role_sum = 0;
   
   foreach ($edit['roles'] as $role) {
        $role_sum = $role_sum + $role;
   }
   
   if ($role_sum == 0) {
        
        $edit['roles'][2] = 1; 
        form_set_error('roles[1]', t('At least one role must be set.'));
   }
   
   $edit['name'] = rtrim($edit['name']);
   $edit['name'] = check_plain($edit['name']);
   
   if (strlen($edit['name']) < 1 || strlen($edit['name']) > 25) {
    form_set_error('name', t('Name of saved settings must be between 1 and 25.'));
   }

    return;    
}

function user_import_set_import($settings) {
  
  if ($settings['iid']) {
  
    db_query("UPDATE {user_import} 
        SET file_handle = '%s', pointer = '%d', processed = '%d', valid= '%d', first_line = '%d', contact = '%d', send_email = '%d', field_match = '%s', username = '%s', abbreviate = '%s', roles = '%s', setting = '%s' 
        WHERE iid = '%d'
        ", $settings['file_handle'], $settings['pointer'], $settings['processed'], $settings['valid'], $settings['first_line'], $settings['contact'],  $settings['send_email'], serialize($settings['field_match']), serialize($settings['username']), serialize($settings['abbreviate']), serialize($settings['roles']), $settings['setting'], $settings['iid']);
        
  } else {
  
    db_query("INSERT INTO {user_import} 
        (iid, file_handle, started, pointer, total, processed, valid, first_line, contact, send_email, field_match, username, abbreviate, roles, setting) 
        VALUES (NULL, '%s', '%d', '%d', '%d', '%d', '%d', '%d', '%d', '%d', '%s', '%s', '%s', '%s', '%s')
        ", $settings['file_handle'], time(), $settings['pointer'], $settings['total'],  $settings['processed'], $settings['valid'], $settings['first_line'], $settings['contact'],  $settings['send_email'], serialize($settings['field_match']), serialize($settings['username']), serialize($settings['abbreviate']), serialize($settings['roles']), $settings['setting']);
        
    $settings['iid'] = db_result(db_query("SELECT LAST_INSERT_ID()"));
    
  }
  
  return $settings;
}


function user_import_set_errors($import_id, $data, $email, $error) {

    $data['email'] = $email;

    db_query("INSERT INTO {user_import_errors} 
        (iid, data, error) 
        VALUES ('%d', '%s', '%s')
        ", $import_id, serialize($data), $error);
     return;
}

function user_import_select_imports($iid = NULL, $get_saved = NULL) {
    
      if ($iid) {
        $query = ($get_saved) ? "SELECT * FROM {user_import} WHERE iid = '%d' AND setting = 'saved' LIMIT 1" : "SELECT * FROM {user_import} WHERE iid = '%d' AND setting != 'saved' LIMIT 1";
        $import = db_fetch_array(db_query($query, $iid));
        $import['field_match'] = unserialize($import['field_match']);
        $import['username'] = unserialize($import['username']);
        $import['abbreviate'] = unserialize($import['abbreviate']);
        $import['roles'] = unserialize($import['roles']);
      } else {
        $query = ($get_saved) ? "SELECT * FROM {user_import} WHERE setting = 'saved'" : "SELECT * FROM {user_import} WHERE setting != 'saved'";
        $results = db_query($query);
        while ($row = db_fetch_array($results)) {
            $row['field_match'] = unserialize($row['field_match']);
            $row['username'] = unserialize($row['username']);
            $row['abbreviate'] = unserialize($row['abbreviate']);
            $row['roles'] = unserialize($row['roles']);
            $import[] = $row;
        }
      }
      
    return $import;      
}

function user_import_select_import_data($iid) {

    $import = db_fetch_array(db_query("SELECT started, pointer, processed, setting FROM {user_import} WHERE iid = %d LIMIT 1", $iid));
    return $import;
}



function user_import_cron() {
    
    $imports = user_import_select_imports();    
    if (!$imports) return;
    
    foreach ($imports as $import) {
        
        if ($import['setting'] == 'test' || $import['setting'] == 'import') user_import_process($import);
    }
        
    return;
}


function user_import_random_username() {

    $vowels = 'aoueiy';
    $consonants = 'bcdfghjklmnpqrstvwxz';
    $length = 8;
    
    mt_srand ((double) microtime() * 10000000);
    $next_vowel = 0;
    
    for ($count = 0; $count <= $length; $count++) {

        if ($next_vowel) {
            $rand = mt_rand(0, 5);
            $username.= $vowels{$rand};
            $next_vowel = 0;
    
        } else {
            $rand = mt_rand(0, 19);
            $username .= $consonants{$rand};
            $next_vowel = 1;
        }
    }
    
    return $username;
}

function user_import_validate_configuration($edit) {

    if (!is_int($edit['user_import_max'])) {
        $edit['user_import_max'] = 250;
        form_set_error('user_import_max', t('Value must be a number. Default has been set.'));
    }
    else {
        if ($edit['user_import_max'] < 10) {
            $edit['user_import_max'] = 10;
            form_set_error('user_import_max', t("Value should be at least 10."));
        }
    }
    
    if (!is_int($edit['user_import_line_max'])) {
        $edit['user_import_line_max'] = 1000;
        form_set_error('user_import_line_max', t('Value must be a number. Default has been set.'));
    }
    else{
        if ($edit['user_import_line_max'] < 1000) {
            $edit['user_import_line_max'] = 1000;
            form_set_error('user_import_line_max', t("Value shouldn't be lower than 1,000."));
        }
        if ($edit['user_import_line_max'] > 1000000) {
            $edit['user_import_line_max'] = 1000;
            form_set_error('user_import_line_max', t("Value shouldn't be higher than 1,000,000."));
        }
    }
    
    if (!is_int($edit['load_settings'])) {
        $edit['load_settings'] = 0;
    }
    
    return $edit;
}

// Clean file - in case of incompatable line endings
function user_import_file_cleaner($filepath) {

    $file = fopen($filepath,'r+');
    while (!feof($file )){
       $line = chop(fgets($file,4096));
       $return = ereg_replace(chr(13) . chr(10),"\n", $line);
       $return = ereg_replace(chr(13),"\n", $return);
       fwrite($file, $return);
    }
    
    fclose($file);
    return;
}
	
function user_import_process($settings) {	
    
    $user_import_line_max = variable_get('user_import_line_max', 1000);
    $settings = _user_import_setting($settings);
    
    // get enabled roles
    while (list ($rid, $set) = each ($settings['roles'])) {
        if ($set == 1) $roles[] = $rid;
    }
    
    $file = file_check_upload($settings['file_handle']);
    $handle = @fopen($file->filepath, "r");
    
    // move pointer to where we last finished
    if ($settings['pointer'] != 0) fseek ($handle, $settings['pointer']);
  
    // start count of imports on this cron run
    $send_counter = 0;
    
    while ($data = fgetcsv($handle, $user_import_line_max, ',')) {
    
        // if importing, check we are not over max number of imports per cron
        if ($settings['setting'] == 'import' && $send_counter > variable_get('user_import_max', 250)) {
            $finished = TRUE;
            break;
        }
        
        $empty_line = (count($data) == 1 && strlen($data[0]) == 0) ? TRUE : FALSE;
       
        // check if this is first line - if so should we skip?
        if (!$empty_line) {
            $first_line_skip = ($settings['processed'] == 0 && !$first_line_skip) ? $settings['first_line'] : NULL;
        }

        if ($first_line_skip != 1 && !$empty_line) {

            unset($email);
            unset($password);
            unset($errors);
            unset($fields);
            reset($settings['field_match']);
            
            while (list ($file_column, $fid) = each ($settings['field_match'])) {
            
                if ($fid == 'email') {
                    $email = trim($data[$file_column]);
                    $errors = user_import_validate_email($email);
                }
                
                if ($fid == 'password') {
                    $password = trim($data[$file_column]);
                }
        
                if ($fid != 0 && $fid != 'email' && $fid != 'password') $fields[$fid] = $data[$file_column];
                
                if ($settings['username'][$file_column] > 0) {
                        $username_data[$file_column]= $data[$file_column];
                        $username_order[$file_column] = $settings['username'][$file_column];
                        $username_abbreviate[$file_column]= $settings['abbreviate'][$file_column];
                } 
            
            }
            
            if (!$errors) {
                
                if ($settings['setting'] == 'import') {

                    $username = user_import_create_username($username_order, $username_data, $username_abbreviate);
                    if (empty($password)) $password = user_password();
    
                    $account = array(
                        "name" => $username,
                        "pass" => $password,
                        "mail" => $email,
                        "init" => $email,
                        "timezone" => "-18000",
                        "status" => 1,
                        "roles" => $roles,
                        "contact" => $settings['contact']);
        
                    $account = user_save('', $account);
                    watchdog('user', t('New user: %name %email.', array('%name' => theme('placeholder', $account->name), '%email' => theme('placeholder', '<'. $account->mail .'>'))), WATCHDOG_NOTICE, l(t('edit'), 'user/'. $account->uid .'/edit'));
                 
                    // import info to profile
                    if (is_array($fields)) {
                        while (list ($fid, $content) = each ($fields)) {
                            user_import_insert_profile($fid, $account->uid, trim($content));
                        }
                    }      
                    
                    if ($settings['send_email']) user_import_send_email($account, $password);
                    $send_counter++;

                }
                
                $settings['valid']++;
            }
            
            $settings['processed']++;

            
        }
        
        $settings['pointer'] = ftell($handle);
        if ($first_line_skip != 1 && !$empty_line) $settings = user_import_set_import($settings);
        
        // save lines that have fatal errors
        if ($errors) user_import_set_errors($settings['iid'], $fields, $email, $errors);
    }
    
    fclose ($handle);
    if ($settings['setting'] == 'import' && !$finished) $settings['setting'] = 'imported';
    if ($settings['setting'] == 'test') $settings['setting'] = 'tested';
    $settings = user_import_set_import($settings);
    
    return $settings;
}

function _user_import_setting($settings) {

     // if existing import, merge settings with import variables
     if ($settings['iid']) {
        
        $import = user_import_select_import_data($settings['iid']);

        // prevent switch from import to test
        if ($settings['setting'] == 'test' || $settings['setting'] == 'testing') {
            if ($import['setting'] == 'import' || $import['setting'] == 'imported') {
                drupal_set_message(t('Once importing has begun, cannot switch to testing.'), 'error');
                drupal_goto ('admin/settings/user_import/list');
            }
        }   
        
        // switching from testing to import
        if ($settings['setting'] == 'import' && ($import['setting'] == 'test' || $import['setting'] == 'tested')) {
            $settings['iid'] = NULL;
            $import['setting'] = 'import';
            $import['pointer'] = 0;
            $import['processed'] = 0;
            $import['valid'] = 0;
        }
        
        // merge settings in db with new settings from form
        $settings = array_merge($import, $settings);
       
     } else {
        $settings['pointer'] = 0;
        $settings['processed'] = 0;
        $settings['valid'] = 0;
    }
    
    return $settings;
}

function _user_import_setting_save($settings) {

    if ($settings['update'] && $settings['load_settings']) {
        db_query("UPDATE {user_import} 
            SET name = '%s', file_handle = '%s', pointer = '%d', processed = '%d', valid= '%d', first_line = '%d', contact = '%d', send_email = '%d', field_match = '%s', username = '%s', abbreviate = '%s', roles = '%s' WHERE iid = '%d'
            ", $settings['saved_settings_name'], $settings['file_handle'], $settings['pointer'], $settings['processed'], $settings['valid'], $settings['first_line'], $settings['contact'],  $settings['send_email'], serialize($settings['field_match']), serialize($settings['username']), serialize($settings['abbreviate']), serialize($settings['roles']), $settings['load_settings']);
        
        drupal_set_message (t("Settings set '%name' was updated.", array('%name' => $settings['saved_settings_name'])));
    }
    
    if ($settings['name']) {
        db_query("INSERT INTO {user_import} 
            (iid, name, file_handle, started, pointer, total, processed, valid, first_line, contact, send_email, field_match, username, abbreviate, roles, setting) 
            VALUES (NULL, '%s', '%s', '%d', '%d', '%d', '%d', '%d', '%d', '%d', '%d', '%s', '%s', '%s', '%s', 'saved')
            ", $settings['name'], $settings['file_handle'], time(), $settings['pointer'], $settings['total'],  $settings['processed'], $settings['valid'], $settings['first_line'], $settings['contact'],  $settings['send_email'], serialize($settings['field_match']), serialize($settings['username']), serialize($settings['abbreviate']), serialize($settings['roles'])); 
        drupal_set_message (t("Settings saved as '%name'.", array('%name' => $settings['name'])));
    }    
    
    return;
}

?>